
# LINE 群組預約機器人技術規格文件

## 1. 系統概述

### 1.1 功能簡介
本系統為基於 LINE Messaging API 的預約管理機器人，整合 Google Apps Script 提供自動化的預約服務。系統可處理座位預約、取消、查詢等功能，並自動維護預約記錄。

### 1.2 技術架構
- 前端介面：LINE 聊天機器人
- 後端服務：Google Apps Script
- 資料儲存：Google Sheets（兩個表格）
- API 整合：LINE Messaging API

## 2. 系統配置

### 2.1 環境變數
```javascript
const CONFIG = {
  LINE_CHANNEL_ACCESS_TOKEN: '...',  // LINE Bot 驗證令牌
  LINE_CHANNEL_SECRET: '...',        // LINE Bot 密鑰
  RAW_SHEET_ID: '...',              // 原始訊息表格 ID
  SUMMARY_SHEET_ID: '...',          // 預約統計表格 ID
  MAX_SEATS: 30,                    // 總座位數上限
  MAX_SEATS_PER_USER: 4,            // 每人預約上限
  CLEAR_TIME: 1                     // 每日清理時間
}
```

### 2.2 資料表結構

#### Messages Table（原始訊息表）
| 欄位 | 類型 | 說明 |
|------|------|------|
| Timestamp | DateTime | 訊息時間戳記 |
| Group ID | String | LINE 群組 ID |
| User ID | String | 使用者 ID |
| User Name | String | 使用者名稱 |
| Increment | Integer | 預約數量（0表示無效預約）|
| Message ID | String | 訊息唯一識別碼 |

#### Bookings Table（預約統計表）
| 欄位 | 類型 | 說明 |
|------|------|------|
| Last Update | DateTime | 最後更新時間 |
| Group ID | String | LINE 群組 ID |
| User ID | String | 使用者 ID |
| User Name | String | 使用者名稱 |
| Total Seats | Integer | 預約總數 |

## 3. 功能規格

### 3.1 預約指令
- 新增預約：
  - 數字格式：+1, +2, +3, +4
  - 中文格式：加一, 加二, 加三, 加四
- 取消預約：
  - 數字格式：-1, -2, -3, -4
  - 中文格式：減一, 減二, 減三, 減四
- 查詢指令：
  - check：查看當前預約狀態
  - name：查看預約者名單

### 3.2 系統限制
- 總座位數上限：10位
- 每人預約上限：4位
- 重複訊息過濾：依據 Message ID 判斷
- 每日自動清理：凌晨1點執行

### 3.3 訊息回應格式
1. 預約成功：
   ```
   已記錄預訂 N 位。目前總計: X 位
   ```

2. 取消成功：
   ```
   已記錄取消 N 位。目前總計: X 位
   ```

3. 預約狀態（check）：
   ```
   目前預訂狀況:
   總預訂人數: X 位
   剩餘座位: Y 位
   ```

4. 預約名單（name）：
   ```
   預訂名單：
   王小明: 4 位
   陳大華: 2 位
   ...
   總計：X 位
   ```

## 4. 系統流程

### 4.1 預約處理流程
1. 訊息接收
2. 訊息類型判斷
3. 重複性檢查
4. 限制條件驗證：
   - 總人數限制
   - 個人預約限制
   - 取消預約限制
5. 資料記錄
6. 統計更新
7. 回傳結果

### 4.2 資料處理流程
1. 原始訊息記錄：
   - 所有訊息都記錄到 Messages table
   - 無效預約記錄為 increment = 0
2. 預約統計更新：
   - 讀取所有有效預約記錄
   - 依據使用者 ID 分組計算
   - 更新 Bookings table

### 4.3 自動維護流程
1. 每日凌晨1點觸發
2. 清空兩個表格資料
3. 保留表格標題列
4. 重新開始記錄

## 5. 錯誤處理

### 5.1 預約錯誤
- 超過總座位數限制
- 超過個人預約上限
- 取消超過已預約數量
- 重複訊息

### 5.2 系統錯誤
- LINE API 連線錯誤
- 表格讀寫錯誤
- 資料解析錯誤

## 6. 維護建議

### 6.1 定期維護
- 監控 API 額度使用狀況
- 檢查表格資料完整性
- 備份重要資料

### 6.2 效能優化
- 設定適當的資料清理週期
- 監控表格大小
- 最佳化查詢效能

## 7. 更新記錄

### Version 1.6
- 新增個人預約上限功能
- 實作取消預約功能
- 新增自動清理機制
- 優化錯誤處理邏輯
- 改進預約統計計算方式
```
